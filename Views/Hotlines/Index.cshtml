@model IEnumerable<old_phone.Models.Hotline>
@{
    ViewBag.Title = "Sổ địa chỉ";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container py-5">
    <h3 class="fw-bold mb-4">Sổ địa chỉ</h3>
    <button type="button" class="btn text-white fw-bold mb-4 rounded-3 px-4 py-2 shadow-sm"
            style="background-color: #ff5722;" onclick="openModal()">
        <i class="bi bi-house-add-fill me-2"></i> Thêm địa chỉ mới
    </button>

    <div class="row g-3" id="hotlineList">
        @foreach (var item in Model)
        {
            <div class="col-12">
                <div class="card border shadow-sm rounded-3 @(item.hotline_default == true ? "border-danger border-opacity-50" : "")">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start">
                            @* Thông tin bên trái *@
                            <div>
                                <div class="d-flex align-items-center gap-3 mb-1">
                                    <h5 class="fw-bold mb-0 text-uppercase">@item.hotline_name</h5>
                                    @if (item.hotline_default == true)
                                    {
                                        <span class="badge bg-danger rounded-pill">Mặc định</span>
                                    }
                                </div>
                                <p class="text-muted mb-1"><span class="fw-bold text-dark">SĐT:</span> @item.hotline_phonenumber</p>
                                <p class="text-muted mb-0"><span class="fw-bold text-dark">Địa chỉ:</span> @item.hotline_address</p>
                            </div>

                            @* Nút thao tác bên phải (AJAX) *@
                            <div class="d-flex flex-column align-items-end gap-2">
                                <div>
                                    @* Nút Sửa *@
                                    <button class="btn btn-link text-warning text-decoration-none fw-bold p-0 me-3"
                                            onclick="openModal('@item.hotline_id', '@item.hotline_name', '@item.hotline_phonenumber', '@item.hotline_address', '@item.hotline_default')">
                                        Sửa
                                    </button>

                                    @* Nút Xóa (Gọi hàm deleteHotlineJS) *@
                                    @if (item.hotline_default != true)
                                    {
                                        <button class="btn btn-link text-danger text-decoration-none fw-bold p-0"
                                                onclick="deleteHotlineJS(@item.hotline_id)">
                                            Xóa
                                        </button>
                                    }
                                </div>

                                @* Nút Set Default (Gọi hàm setDefaultJS) *@
                                @if (item.hotline_default != true)
                                {
                                    <button class="btn btn-outline-secondary btn-sm rounded-pill"
                                            onclick="setDefaultJS(@item.hotline_id)">
                                        Đặt làm mặc định
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@* --- MODAL (POPUP) THÊM / SỬA --- *@
<div class="modal fade" id="addressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-danger" id="modalTitle">Thêm địa chỉ mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            @* Dùng form thường để JS xử lý *@
            <form id="hotlineForm">
                <div class="modal-body">
                    <input type="hidden" name="hotline_id" id="inpId" value="0" />

                    <div class="mb-3">
                        <label class="form-label fw-bold text-muted small">Tên Người Nhận</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-person"></i></span>
                            <input type="text" class="form-control border-start-0" name="hotline_name" id="inpName" required placeholder="VD: Nguyễn Văn A">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold text-muted small">Số Điện Thoại</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="bi bi-telephone"></i></span>
                            <input type="text" class="form-control border-start-0" name="hotline_phonenumber" id="inpPhone" required placeholder="VD: 0988xxxxxx">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold text-muted small">Địa Chỉ Chi Tiết</label>
                        <textarea class="form-control" name="hotline_address" id="inpContent" rows="3" required placeholder="Số nhà, tên đường, phường/xã..."></textarea>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="hotline_default" value="true" id="inpDefault">
                        <label class="form-check-label user-select-none" for="inpDefault">
                            Đặt làm địa chỉ mặc định
                        </label>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Hủy</button>
                    @* Nút Submit gọi hàm JS *@
                    <button type="button" onclick="submitHotline()" class="btn btn-danger rounded-pill px-4 fw-bold" style="background-color: #ff5722; border:none;">Lưu thay đổi</button>
                </div>
            </form>
        </div>
    </div>
</div>

@* --- SCRIPT XỬ LÝ AJAX --- *@
<script>
    // 1. Hàm Mở Modal (Giữ nguyên logic cũ)
    function openModal(id = 0, name = '', phone = '', content = '', isDefault = 'False') {
        document.getElementById('inpId').value = id;
        document.getElementById('inpName').value = name;
        document.getElementById('inpPhone').value = phone;
        document.getElementById('inpContent').value = content;
        document.getElementById('inpDefault').checked = (isDefault === 'True');

        var title = document.getElementById('modalTitle');
        title.innerText = (id == 0) ? "Thêm địa chỉ mới" : "Chỉnh sửa địa chỉ";

        var myModal = new bootstrap.Modal(document.getElementById('addressModal'));
        myModal.show();
    }

    // 2. Lưu (Thêm/Sửa) Hotline - AJAX
    async function submitHotline() {
        var form = document.getElementById('hotlineForm');
        // Validate cơ bản
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        var formData = new FormData(form);
        // Fix lỗi checkbox: Nếu không check thì FormData không gửi value 'false', ta phải tự xử lý hoặc để backend lo
        // (Trong C#, bool mặc định là false nếu ko gửi lên -> OK)

        try {
            const response = await fetch('@Url.Action("AddOrEditJS", "Hotlines")', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            alert(data.message);
            if (data.success) location.reload(); // Reload để cập nhật danh sách
        } catch (e) { console.error(e); alert("Lỗi kết nối!"); }
    }

    // 3. Xóa Hotline - AJAX
    async function deleteHotlineJS(id) {
        if (!confirm('Bạn có chắc chắn muốn xóa địa chỉ này?')) return;

        try {
            const response = await fetch('@Url.Action("DeleteJS", "Hotlines")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            });
            const data = await response.json();

            alert(data.message);
            if (data.success) location.reload();
        } catch (e) { console.error(e); alert("Lỗi kết nối!"); }
    }

    // 4. Đặt Mặc định - AJAX
    async function setDefaultJS(id) {
        try {
            const response = await fetch('@Url.Action("SetDefaultJS", "Hotlines")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            });
            const data = await response.json();

            alert(data.message);
            if (data.success) location.reload();
        } catch (e) { console.error(e); alert("Lỗi kết nối!"); }
    }
</script>