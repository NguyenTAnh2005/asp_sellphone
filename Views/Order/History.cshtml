@model List<old_phone.ViewModels.OrderHistoryViewModel>

@{
    ViewBag.Title = "Lịch Sử Đơn Hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container py-5">
    <div class="text-center mb-5">
        <h3 class="fw-bold text-uppercase text-primary">
            <i class="bi bi-clock-history me-2"></i> Lịch Sử Mua Hàng
        </h3>
    </div>

    <div class="card border-0 shadow-sm rounded-4 mb-4 bg-white">
        <div class="card-body p-3">
            @using (Html.BeginForm("History", "Order", FormMethod.Get, new { id = "filterForm" }))
            {
                <div class="d-flex justify-content-end align-items-center">
                    <label class="fw-bold me-3 text-secondary d-none d-md-block">
                        <i class="bi bi-funnel-fill"></i> Trạng thái đơn hàng:
                    </label>

                    <div style="min-width: 250px;">
                        @* Dropdown list lấy từ ViewBag.StatusList *@
                        @Html.DropDownList("status", ViewBag.StatusList as SelectList, new
                        {
                            @class = "form-select border-primary bg-light fw-bold text-primary",
                            @onchange = "this.form.submit();" // Tự động submit khi chọn
                        })
                    </div>
                </div>
            }
        </div>
    </div>

    <hr class="text-muted opacity-25 mb-4" />

    @if (Model != null && Model.Any())
    {
        <div class="row g-4">
            @foreach (var order in Model)
            {
                // Chuyển đổi trạng thái từ số sang chữ/màu sắc để hiển thị Badge
                int stateId = order.order_state;

                string badgeClass = "bg-secondary";
                string stateText = "Không xác định";

                switch (stateId)
                {
                    case 0: badgeClass = "bg-warning text-dark"; stateText = "Chờ xác nhận"; break;
                    case 1: badgeClass = "bg-info text-dark"; stateText = "Đang chuẩn bị"; break;
                    case 2: badgeClass = "bg-primary"; stateText = "Đang giao hàng"; break;
                    case 3: badgeClass = "bg-success"; stateText = "Giao thành công"; break;
                    case 4: badgeClass = "bg-danger"; stateText = "Đã hủy"; break;
                }

                <div class="col-12">
                    <div class="card shadow-sm border-0">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="fw-bold mb-1">
                                        Đơn Hàng #@order.order_id
                                    </h5>
                                    <small class="text-muted">Đặt ngày: @order.order_buy_time.ToString("dd/MM/yyyy HH:mm")</small>
                                </div>
                                <span class="badge rounded-pill @badgeClass px-3 py-2 shadow-sm">@stateText</span>
                            </div>

                            <hr />

                            @* Chi tiết sản phẩm *@
                            <div class="mb-3">
                                <span class="fw-bold small me-2">Sản phẩm:</span>
                                @if (order.ItemNames.Any())
                                {
                                    <span class="text-secondary small">
                                        @string.Join(", ", order.ItemNames)
                                        @if (order.TotalItemCount > order.ItemNames.Count)
                                        {
                                            @: và @(order.TotalItemCount - order.ItemNames.Count) sản phẩm khác...
                                        }
                                        else if (order.ItemNames.Count == 1)
                                        {
                                            @: (@order.TotalItemCount sản phẩm)
                                        }
                                    </span>
                                }
                                else
                                {
                                    <span class="text-danger small">Không tìm thấy chi tiết sản phẩm.</span>
                                }
                            </div>

                            @* Tổng tiền & Thanh toán *@
                            <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                                <div>
                                    <span class="fw-bold text-danger fs-5">
                                        @string.Format("{0:N0} đ", order.order_total_price)
                                    </span>
                                </div>
                                <div>
                                    <small class="text-muted me-2">Hình thức thanh toán:</small>
                                    
                                        @*order.order_type_pay == "COD" ? "COD - Thanh toán khi nhận hàng" : "QR: Đã chuyển khoản trước";*@

                                    <span class="fw-bold text-dark">
                                        @switch (order.order_type_pay)
                                        {
                                            case "COD":
                                                @:COD - Thanh toán khi nhận hàng
                                                break;
                                            case "QR":
                                                @:QR: Đã chuyển khoản trước
                                                break;
                                            default:
                                                @:Không xác định
                                                break;
                                        }
                                    </span>

                                    @* Nút Xem Chi Tiết (Bạn có thể phát triển thêm) *@
                                    <a href=@Url.Action("Details", "Order", new { id = order.order_id }) class="btn btn-sm btn-outline-secondary ms-3">
                                        Xem Chi Tiết <i class="bi bi-chevron-right"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
                                            {
<div class="text-center py-5">
    <div class="mb-3">
        <i class="bi bi-clipboard-x display-1 text-muted opacity-25"></i>
    </div>
    <h5 class="text-muted">Không tìm thấy đơn hàng nào theo bộ lọc này.</h5>
    <a href="@Url.Action("History", new { status = -1 })" class="btn btn-link text-decoration-none">Xem tất cả đơn hàng</a>
    <br />
    <a href="@Url.Action("Index","Shop")" class="btn btn-link text-decoration-none">Quay về trang chủ</a>

</div>
    }
</div>