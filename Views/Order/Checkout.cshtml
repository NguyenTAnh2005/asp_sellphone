@model old_phone.ViewModels.OrderViewModel

@{
    ViewBag.Title = "Thanh Toán Đơn Hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // 1. Tính tổng tiền
    // * Sử dụng .GetValueOrDefault() để tránh lỗi nếu price hoặc count là null (best practice)
    decimal totalPrice = Model.OrderItems.Sum(i => (i.price * i.count));

    // 2. Ngày giờ
    var today = DateTime.Now.ToString("dd/MM/yyyy");
    var receiveDay = DateTime.Now.AddDays(3).ToString("dd/MM/yyyy");
}
<div class="container py-5">
    <div class="text-center mb-4">
        <h3 class="fw-bold text-main-CL text-uppercase">
            <i class="bi bi-receipt"></i> Xác Nhận Đơn Hàng
        </h3>
    </div>

    @* Form POST để gửi thông tin thanh toán về OrderController/ProcessOrder *@
    @using (Html.BeginForm("ProcessOrder", "Order", FormMethod.Post, new { @class = "row g-4" }))
    {
        @Html.AntiForgeryToken()

        <div class="col-lg-7">

            @* --- 1. KHỐI THÔNG TIN NGÀY GIỜ --- *@
            <div class="card border-0 shadow-sm rounded-3 mb-4 overflow-hidden">
                <div class="card-header bg-main-CL text-white fw-bold">
                    <i class="bi bi-clock-history me-2"></i> Thời gian giao hàng dự kiến
                </div>
                <div class="card-body bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted d-block">Ngày đặt hàng</small>
                            <span class="fw-bold text-dark">@today</span>
                        </div>
                        <div class="text-main-CL fs-4"><i class="bi bi-arrow-right"></i></div>
                        <div class="text-end">
                            <small class="text-muted d-block">Dự kiến nhận hàng (+3 ngày)</small>
                            <span class="fw-bold text-success">@receiveDay</span>
                        </div>
                    </div>
                </div>
            </div>

            @* --- 2. THÔNG TIN GIAO HÀNG & THANH TOÁN --- *@
        <div class="card border-0 shadow-sm rounded-3 p-4">
            <h5 class="fw-bold text-main-CL mb-3">Thông tin nhận hàng</h5>

            @* Chọn Địa Chỉ (Dùng SELECT BOX theo yêu cầu) *@
            <div class="mb-4">
                <label class="form-label fw-bold text-muted small">Địa chỉ nhận hàng</label>
                @if (Model.listHotlines != null && Model.listHotlines.Any())
                {
                    <select class="form-select" name="Order_HotlineId" required>
                        @foreach (var h in Model.listHotlines)
                        {
                            <option value="@h.hotline_id" @(h.hotline_default == true ? "selected" : "")>
                                @h.hotline_name - @h.hotline_phonenumber (@h.hotline_address) @(h.hotline_default == true ? "(Mặc định)" : "")
                            </option>
                        }
                    </select>
                    <div class="mt-2 text-end">
                        <a href="@Url.Action("Index", "Hotlines", new { returnUrl = "Checkout" })" class="text-decoration-none small text-main-CL">
                            <i class="bi bi-plus-circle"></i> Thêm địa chỉ mới
                        </a>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">
                        Chưa có địa chỉ nào. <a href="@Url.Action("Index", "Hotlines")">Thêm ngay</a>
                    </div>
                }
            </div>

            @* Chọn Phương Thức Thanh Toán (Radio Buttons đã disable Banking) *@
            @* --- 2. PHƯƠNG THỨC THANH TOÁN (Cập nhật Value thành số) --- *@
            <div class="card border-0 shadow-sm rounded-3 mb-4 overflow-hidden">
                <div class="card-header bg-main-CL text-white py-3">
                    <h5 class="fw-bold mb-0"><i class="bi bi-credit-card-2-front"></i> Phương Thức Thanh Toán</h5>
                </div>
                <div class="card-body p-4">
                    <div class="form-check mb-3 p-3 border rounded-3 bg-light">
                        @* Value = 0: Thanh toán khi nhận hàng *@
                        @Html.RadioButtonFor(m => m.Order_TypePayment,"COD", new { @class = "form-check-input", @checked = "checked", id = "pay_cod" })
                        <label class="form-check-label w-100 fw-bold text-dark" for="pay_cod">
                            <i class="bi bi-cash-coin me-2 text-success"></i> Thanh toán khi nhận hàng (COD)
                            <div class="small text-muted fw-normal mt-1">Bạn sẽ thanh toán tiền mặt cho shipper khi nhận được hàng.</div>
                        </label>
                    </div>

                    <div class="form-check p-3 border rounded-3 bg-light opacity-50">
                        @* Value = 1: Chuyển khoản *@
                        @Html.RadioButtonFor(m => m.Order_TypePayment, "QR", new { @class = "form-check-input", id = "pay_bank", disabled="disabled" })
                        <label class="form-check-label w-100 fw-bold text-dark" for="pay_bank">
                            <i class="bi bi-bank me-2 text-primary"></i> Chuyển khoản ngân hàng  (QR Code) (Chức năng đang được phát triển )
                            <div class="small text-muted fw-normal mt-1">Quét mã QR để thanh toán nhanh chóng và chính xác.</div>
                        </label>
                    </div>
                    @Html.ValidationMessageFor(m => m.Order_TypePayment, "", new { @class = "text-danger small" })
                </div>
            </div>
        </div>
        </div>

        @* --- CỘT PHẢI: LIST SẢN PHẨM & TỔNG KẾT --- *@
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm rounded-3 p-0 overflow-hidden position-sticky" style="top: 100px;">
                <div class="card-header header-bg fw-bold text-main-CL py-3">
                    Danh sách sản phẩm (@Model.OrderItems.Count())
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        @foreach (var item in Model.OrderItems)
                        {
                            <li class="list-group-item d-flex align-items-center py-3">
                                <img src="@item.image_url" style="width: 60px; height: 60px; object-fit: contain;" class="border rounded me-3">

                                <div class="flex-grow-1">
                                    <h6 class="mb-0 text-truncate-2 small fw-bold">@item.name</h6>
                                    <small class="text-muted">@item.ram GB / @item.rom GB</small>
                                </div>

                                <div class="text-end ms-2">
                                    @* HIỂN THỊ SỐ LƯỢNG *@
                                    <small class="d-block text-muted">x @item.count</small>
                                    <span class="fw-bold text-main-CL">@string.Format("{0:N0} đ", item.price)</span>
                                </div>

                                @* INPUT ẨN để gửi dữ liệu sản phẩm * - QUAN TRỌNG CHO LƯU DATA *@
                                <input type="hidden" name="SelectedVariantIds" value="@item.variant_id" />

                                @* Dùng input ẩn để gửi lại số lượng, đề phòng trường hợp model binding *
                                    @* mặc dù ở logic ProcessOrder ta đã dùng TempData rồi, nhưng đây là cách an toàn hơn *@
                                <input type="hidden" name="SelectedQuantities" value="@item.count" />
                            </li>
                        }
                    </ul>
                </div>

                @* KHỐI TỔNG KẾT VÀ NÚT ĐẶT HÀNG *@
                <div class="card-footer bg-white p-4 border-top">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold text-secondary">Tạm tính:</span>
                        <span class="fw-bold">@string.Format("{0:N0} đ", totalPrice)</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="fw-bold text-secondary">Phí vận chuyển:</span>
                        <span class="fw-bold text-success">FREE</span>
                    </div>

                    <hr class="mt-0" />

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="fw-bold text-danger fs-5">Tổng thanh toán:</span>
                        <span class="fw-bold fs-4 text-danger">@string.Format("{0:N0} đ", totalPrice)</span>
                    </div>

                    <button type="submit" class="btn bg-main-CL text-white w-100 rounded-pill fw-bold py-3 text-uppercase shadow-sm">
                        Xác nhận đặt hàng
                    </button>

                    <p class="text-center text-muted small mt-2">Bấm Đặt Hàng là bạn đã đồng ý với Điều khoản mua hàng</p>
                </div>
            </div>
        </div>
    }
</div>