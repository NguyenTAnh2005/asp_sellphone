@model old_phone.ViewModels.ManageSaleViewModel

@{
    ViewBag.Title = "Cập Nhật Khuyến Mãi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-warning text-dark py-3 text-center">
                    <h4 class="fw-bold mb-0"><i class="bi bi-pencil-square me-2"></i> CẬP NHẬT GIÁ & THỜI GIAN</h4>
                </div>
                <div class="card-body p-4">
                    @using (Html.BeginForm())
                    {
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(model => model.sale_id)
                        @Html.HiddenFor(model => model.variant_id)
                        
                        <div class="card bg-light border-0 mb-4">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="fw-bold text-muted">Sản Phẩm Đang Sale:</label>
                                    @Html.DropDownList("variant_id", null, htmlAttributes: new { @class = "form-select", @disabled = "disabled" })
                                </div>

                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold text-secondary">Giá Niêm Yết (New Price)</label>
                                        <div class="input-group">
                                            @Html.EditorFor(model => model.CurrentNewPrice, new { htmlAttributes = new { @class = "form-control bg-white", @readonly = "readonly", id = "CurrentNewPrice" } })
                                            <span class="input-group-text">VNĐ</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold text-danger">Giá Khuyến Mãi (Final Price)</label>
                                        <div class="input-group">
                                            @Html.EditorFor(model => model.DiscountPrice, new { htmlAttributes = new { @class = "form-control fw-bold text-danger", type = "number", id = "DiscountPrice" } })
                                            <span class="input-group-text bg-danger text-white">VNĐ</span>
                                        </div>
                                        @Html.ValidationMessageFor(model => model.DiscountPrice, "", new { @class = "text-danger small" })
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Tên Chương Trình</label>
                            @Html.EditorFor(model => model.sale_name, new { htmlAttributes = new { @class = "form-control" } })
                            @Html.ValidationMessageFor(model => model.sale_name, "", new { @class = "text-danger small" })
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-6">
                                <label class="form-label fw-bold">Bắt đầu</label>
                                @Html.TextBoxFor(m => m.sale_start, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date" })
                                @Html.ValidationMessageFor(model => model.sale_start, "", new { @class = "text-danger small" })
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold">Kết thúc</label>
                                @Html.TextBoxFor(m => m.sale_end, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date" })
                                @Html.ValidationMessageFor(model => model.sale_end, "", new { @class = "text-danger small" })
                            </div>
                        </div>

                        <div class="text-end pt-3 border-top">
                            <a href="@Url.Action("Index")" class="btn btn-light border rounded-pill px-4">Hủy</a>
                            <button type="submit" class="btn btn-warning rounded-pill px-5 fw-bold shadow-sm">Cập Nhật</button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts { 
    @Scripts.Render("~/bundles/jqueryval")
    
    <script type="text/javascript">
        // JavaScript thuần để load giá sản phẩm khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            var currentNewPriceInput = document.getElementById('CurrentNewPrice');
            var discountPriceInput = document.getElementById('DiscountPrice');
            
            // Format số với dấu phẩy khi hiển thị
            if (currentNewPriceInput && currentNewPriceInput.value) {
                var currentPrice = parseFloat(currentNewPriceInput.value);
                if (!isNaN(currentPrice)) {
                    // Giữ giá trị số nguyên trong input để submit đúng
                    currentNewPriceInput.setAttribute('data-original-value', currentPrice);
                }
            }
            
            // Thêm validation realtime cho discount price
            if (discountPriceInput && currentNewPriceInput) {
                discountPriceInput.addEventListener('input', function() {
                    var discountPrice = parseFloat(this.value);
                    var currentPrice = parseFloat(currentNewPriceInput.value);
                    
                    if (!isNaN(discountPrice) && !isNaN(currentPrice)) {
                        if (discountPrice >= currentPrice) {
                            this.setCustomValidity('Giá khuyến mãi phải nhỏ hơn giá niêm yết');
                            this.classList.add('is-invalid');
                        } else if (discountPrice <= 0) {
                            this.setCustomValidity('Giá khuyến mãi phải lớn hơn 0');
                            this.classList.add('is-invalid');
                        } else {
                            this.setCustomValidity('');
                            this.classList.remove('is-invalid');
                        }
                    }
                });
            }
        });
    </script>
}